#!/bin/bash

cd <%= @package[:package]+"/src/"+@package[:git_org]+"/beedi" %>

# sometimes  the dependencies aren't getting pulled. Adding a master solved the problem.
git remote add master https://gitlab.com/rajesh_rajagopal/beedi.git
# make test
make controller

cat > VERSION << EOF
git_version=`git rev-parse HEAD`
git_branch=`git branch`
EOF

cd ../../../../..

cp ../../../entrypoint.sh .

sudo docker build -t rio-controller -f Dockerfile .

sudo docker tag rio-controller <%= @basic[:registry_url]+"/riooscontroller:"+@basic[:version] %>

sudo docker push <%= @basic[:registry_url]+"/riooscontroller:"+@basic[:version] %>
