#!/bin/bash

# -------------------------------------------------------------------------- #
# Copyright 2017 RioCorp inc.                                                #
#                                                                            #
#--------------------------------------------------------------------------- #

function export_rc_vars
{
    if [ -f $1 ] ; then
        RIOOS_VARS=`cat $1 | egrep -e '^[a-zA-Z\-\_0-9]*=' | sed 's/=.*$//'`

        . $1

        for v in $RIOOS_VARS; do
            export $v
        done
    fi
}

function execute_scripts {
    SCRIPTS_DIR="/etc/rioos-bootstrap.d"
    for script in $SCRIPTS_DIR/*; do
        $script
    done
}

function start {
    CONTEXT_DEV=`blkid -l -t LABEL="CONTEXT" -o device`
    if [ -e "$CONTEXT_DEV" ]; then
        mount -t iso9660 -L CONTEXT -o ro /mnt
        if [ -f /mnt/context.sh ]; then
            export_rc_vars /mnt/context.sh
            cp /mnt/context.sh /tmp/context.sh
        fi

        execute_scripts

        umount /mnt
    elif curl -o /tmp/context.sh http://169.254.169.254/latest/user-data ; then
        export_rc_vars /tmp/context.sh
        execute_scripts
    elif type vmtoolsd ; then
        vmtoolsd --cmd 'info-get guestinfo.opennebula.context' | \
            openssl base64 -d > /tmp/context.sh
        export_rc_vars /tmp/context.sh
        execute_scripts
    fi
}

start
